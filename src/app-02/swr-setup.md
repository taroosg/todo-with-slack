# データ取得タイミングの最適化

ここまで，講義 1 回めで使用した `useEffect` を用いてデータを取得していたが，最新の情報を取得するには再度読み込みを行う必要があった．

しかし，頻繁に情報が更新されるアプリケーションの場合，ユーザの再読込をトリガにしたデータ取得は現実的ではない．

本項では，様々なデータ取得タイミングを解説し，本アプリケーションに適した処理を実装する．

## データ取得と反映方法の紹介

雑な紹介は以下のとおり．

| 名称 | 概要                                                                                                                                                                                                                                            |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SSR  | サーバ側で HTML を生成する方式．クライアント側で JS が実行されなくてもコンテンツが存在する状況となる．                                                                                                                                          |
| SSG  | サーバ上で，MD ファイルなどから HTML ファイルを生成し，クライアント側からは HTML ファイルを読むだけにする方式．サーバ上には静的な（static） HTML が置かれている状況となる．ソースデータが更新された場合は開発者側が再度ビルドを行う必要がある． |
| ISR  | SSG を効率よく実現するための方法．指定時間毎に SSG のビルドを行うことができる．開発者が都度ビルドを行うことなく，アプリケーションの状態を最新に保つことができる．                                                                               |
| CSR  | クライアント側で動作する JS が HTML 要素を生成する方式．主にサーバから JSON 形式のデータを受け取り， JS が HTML 要素を構築して画面に表示される流れとなる．React では useEffect や axios を使用した一般的な実装．                                |
| SWR  | CSR を効率よく実現するための方法．クライアント側で再読込を行わなくても，指定時間毎やユーザ操作のタイミングでデータ取得処理を動作させることができる．useSWR を使用して実装が可能．                                                               |

## 使い分け

データを取得するタイミングによる．

クライアント側の状態をどの程度の頻度で最新に保つ必要があるのかにより，最適な実装は異なる．

いくつかの例を以下に示す．

| 状況                                   | 実装            |
| -------------------------------------- | --------------- |
| 開発者の個人ブログ，ドキュメントなど． | SSG             |
| ユーザ投稿型のブログなど．             | SSG（ISR 使用） |
| ユーザ短文投稿型の SNS など．          | CSR（SWR 使用） |

より厳密なリアルタイム性が求められる場合（ユーザ同士のチャットアプリケーションなど）にはサーバ側で web socket の実装などを行う必要がある．

## 実装

今回のアプリケーションでは，すでに CSR にて実装を行っている．

todo 一覧表示において，より柔軟なタイミングで最新のデータが取得できるよう SWR を用いた実装を追加で行う．

## SWR 処理の実装

SWR の機能はライブラリとして提供されている．

下記コマンドでインストールする．

```bash
$ npm i swr
```

`TodoIndex.jsx` を以下のように編集する．

データを取得するための `fetcher` 関数を定義し，`useSWR` で「リクエスト先」と「データ取得関数」を指定する．

> 解説
>
> - 取得したデータと失敗した場合のエラーはそれぞれ `data` と `error` に格納される．
>
> - データが取得できなかった場合やエラーが発生しない場合はそれぞれ `undefined` となるため，容易に条件分岐することができる．

```js
// src/pages/TodoIndex.jsx

// 省略

// 🔽 追加
import useSWR from "swr";

export const TodoIndex = () => {
  // 省略

  // 🔽 追加
  const fetcher = async (url) => (await axios.get(url)).data.result;

  // 🔽 追加
  const { data, error } = useSWR("http://localhost:3001/todo", fetcher);

  // 🔽 追加
  return (
    <ul>
      {data?.map((x, i) => (
        <Todo
          key={x.id}
          id={x.id}
          todo={x.todo}
          deadline={x.deadline}
          is_done={x.is_done}
          user_id={x.user_id}
          created_at={x.created_at}
          updated_at={x.updated_at}
          getData={getAllTodo}
        />
      ))}
    </ul>
  );
};
```

## 動作確認

これまでと同様の動作になっていれば OK．
